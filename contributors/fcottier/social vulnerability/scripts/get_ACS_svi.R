# Fabien Cottier, D4 HACK
# Summer 2024

# setup

## libraries
library(tidyverse)
library(foreach)
library(doFuture)
library(countrycode)
library(tidycensus)
library(tigris)
library(tictoc)
library(mapdeck)

## get 2000 variable dictionary
dict <- tidycensus::load_variables(year = 2000, dataset = "sf3")
View(dict)

## census API and mapdeck keys 
source("../api_keys/keys.R")

## functions
get_decennial_incNY <- function(year, variables = variables, geometry = FALSE){
  tidycensus::get_decennial(
    variables = variables,
    summary_var = c("P001001"),
    geography = "county",
    state = "NY",
    year = year,
    geometry = geometry,
    sumfile = "sf3",
    output = "wide"
  )
}
get_decennial_inc <- function(state = i, year, variables = variables, geometry = FALSE) {
  tidycensus::get_decennial(
    variables = variables,
    summary_var = c("P001001"),
    geography = "county",
    state = state,
    year = year,
    geometry = geometry,
    sumfile = "sf3",
    output = "wide"
  )
}

# script test

## variables
variables <- c(
  medIncHH = "P053001", # aggregate household income 1999
  poverty = "P087001" # poverty status in 1999,
  labM = "P043003" # total civilian labor force: male
  labF = "P043010" # total civilian labor force: female
  uempM = "P043007", # total civilian labor force / unemployed: male
  uempF = "P043014" # total civilian labor force / unemployed: female
)

## county-to-county New York
tic()
test_cnty <- get_decennial_incNY(
  year = 2000,
  variables = variables,
  geometry = FALSE
)
toc()


# extract county to county data

# parameters
stateList <- datasets::state.abb
variables <- c(
  medIncHH = "P053001", # aggregate household income 1999
  poverty = "P087001", # poverty status in 1999,
  labM = "P043003", # total civilian labor force: male
  labF = "P043010", # total civilian labor force: female
  uempM = "P043007", # total civilian labor force / unemployed: male
  uempF = "P043014" # total civilian labor force / unemployed: female
)

plan(multisession)


## All states
tic()
US_dec_income <- foreach (i = stateList, .combine=rbind) %dofuture% {
  f <- get_decennial_inc(state = i, variables = variables, year = 2000)
  return(f)
} %globals% c("variables", "get_decennial_inc") %seed% TRUE
toc()
US_dec_income 


## export data
readr::write_rds(US_dec_income, file = "rawDatasets/dec2000_income_county.Rds", compress = "gz")