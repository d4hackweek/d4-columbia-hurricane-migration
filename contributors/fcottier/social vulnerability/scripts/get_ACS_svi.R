# Fabien Cottier, D4 HACK
# Summer 2024

# setup

## libraries
library(tidyverse)
library(foreach)
library(doFuture)
library(countrycode)
library(tidycensus)
library(tigris)
library(tictoc)
library(mapdeck)

## get 2000 variable dictionary
dict <- tidycensus::load_variables(year = 2000, dataset = "sf3")
View(dict)

## census API and mapdeck keys 
source("../api_keys/keys.R")

## variables
variables_SF3 <- c(
  medIncHH = "P053001", # aggregate household income 1999
  poverty = "P087002", # poverty status in 1999 // below federal poverty line,
  labM = "P043003", # total civilian labor force: male
  labF = "P043010", # total civilian labor force: female
  uempM = "P043007", # total civilian labor force / unemployed: male
  uempF = "P043014", # total civilian labor force / unemployed: female,
  ownerOcc = "H007002",
  renterOcc = "H007003"
)
variables_SF1 <- c(
  blackAlone = "P003004" # aggregate household income 1999)
)

## functions
get_decennial_inc <- function(state = i, year, variables = variables, geometry = FALSE, sf = "sf3") {
  tidycensus::get_decennial(
    variables = variables,
    summary_var = c("P001001"),
    geography = "county",
    state = state,
    year = year,
    geometry = geometry,
    sumfile = sf,
    output = "wide"
  )
}

# script test

## county-to-county New York
tic()
test_cnty <- get_decennial_inc(
  year = 2000,
  state = "NY",
  variables = variables_SF3,
  geometry = FALSE
)
toc()

# extract county to county data

# parameters
stateList <- datasets::state.abb
#plan(multisession)

## All states
tic()
US_dec_sf3 <- foreach (i = stateList, .combine=rbind) %dofuture% {
  f <- get_decennial_inc(state = i, variables = variables_SF3, year = 2000)
  return(f)
} %globals% c("variables", "get_decennial_inc") %seed% TRUE
toc()
US_dec_sf3 

tic()
US_dec_sf1 <- foreach (i = stateList, .combine=rbind) %dofuture% {
  f <- get_decennial_inc(state = i, variables = variables_SF1, year = 2000, sf = "sf1")
  return(f)
} %globals% c("variables", "get_decennial_inc") %seed% TRUE
toc()
US_dec_sf1 

## recode data
US_dec <- US_dec_sf3 %>%
  dplyr::left_join(dplyr::select(US_dec_sf1, -summary_value)) %>%
  dplyr::rename(pop_2000 = "summary_value")  %>%
  dplyr::mutate(
    povertyL_2000 = poverty / pop_2000,
    unempl_2000 =  (uempM + uempF) / (labM + labF),
    ownerL_2000 = ownerOcc/(ownerOcc + renterOcc), # only occupied units,
    afroAmerL_2000 = blackAlone / pop_2000
  ) %>%
  dplyr::select(GEOID, pop_2000, medIncHH, povertyL_2000, unempl_2000, ownerL_2000, afroAmerL_2000)


## export data
readr::write_csv(US_dec, file = "contributors/fcottier/social vulnerability/US_dec_2000.csv")
